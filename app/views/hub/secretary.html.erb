<% content_for :head do %>
  <%= stylesheet_link_tag "hub", "data-turbo-track": "reload" %>
<% end %>

<div class="secretary-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå›ºå®šï¼‰ -->
  <div class="secretary-header">
    <%= link_to "â†", root_path, class: "back-link" %>
    <div class="header-info">
      <h1>ğŸ¤µ ç§˜æ›¸</h1>
      <p>mode A</p>
    </div>
  </div>

  <!-- ä¼šè©±ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ -->
  <div class="secretary-chat" id="chat-messages">
    <% if @messages.blank? %>
      <div class="empty-state">
        <p>ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
        <p class="sub">ä½•ã§ã‚‚è©±ã—ã‹ã‘ã¦ãã ã•ã„</p>
      </div>
    <% else %>
      <div class="chat-container">
        <% @messages.each do |message| %>
          <div class="chat-message <%= message.role == 'user' ? 'chat-message-user' : '' %>">
            <div class="chat-avatar <%= message.role == 'assistant' ? 'chat-avatar-assistant' : '' %>">
              <%= message.role == 'user' ? 'ta9' : 'ç§˜æ›¸' %>
            </div>
            <div class="chat-message-content">
              <div class="chat-bubble <%= message.role == 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant' %>">
                <%= simple_format(message.content) %>
                <% if message.image_url.present? %>
                  <img src="<%= message.image_url %>" class="chat-image" alt="æ·»ä»˜ç”»åƒ">
                <% end %>
              </div>
              <div class="chat-time">
                <%= message.created_at.strftime('%H:%M') %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆå›ºå®šï¼‰ -->
  <div class="secretary-input">
    <%= form_with url: hub_send_message_path,
                  method: :post,
                  multipart: true,
                  data: {
                    controller: "line-chat",
                    action: "submit->line-chat#send"
                  } do |f| %>

      <div data-line-chat-target="previewContainer" style="display: none;" class="image-preview-container">
        <img data-line-chat-target="preview" class="image-preview" />
        <button type="button" class="image-preview-remove" data-action="click->line-chat#removeImage">å‰Šé™¤</button>
      </div>

      <div class="input-toolbar">
        <label class="input-attach-btn">
          ï¼‹
          <%= f.file_field :image,
                           accept: "image/*",
                           capture: "environment",
                           style: "display: none;",
                           data: {
                             action: "change->line-chat#previewImage",
                             "line-chat-target": "fileInput"
                           } %>
        </label>

        <div class="input-field-wrapper">
          <%= f.text_area :message,
                          rows: 1,
                          placeholder: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...",
                          data: {
                            "line-chat-target": "input",
                            action: "keydown->line-chat#handleKeydown input->line-chat#autoResize"
                          } %>
          <button type="submit" class="input-send-btn" data-line-chat-target="submit">â–¶</button>
        </div>
      </div>

      <div class="model-select">
        <%= f.select :model,
                     [["Sonnet 4.5", "claude-sonnet-4.5"], ["GPT-4o", "gpt-4o"]],
                     {} %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«å®Ÿè¡Œï¼‰
  function scrollToBottom() {
    const chat = document.getElementById('chat-messages');
    if (chat) {
      chat.scrollTop = chat.scrollHeight;
    }
  }
  // è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ç¢ºå®Ÿã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  document.addEventListener('DOMContentLoaded', scrollToBottom);
  document.addEventListener('turbo:load', scrollToBottom);
  document.addEventListener('turbo:render', scrollToBottom);
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«ã‚‚å®Ÿè¡Œï¼ˆç”»åƒèª­ã¿è¾¼ã¿å¾…ã¡ï¼‰
  window.addEventListener('load', function() {
    setTimeout(scrollToBottom, 100);
  });
  // å³åº§ã«å®Ÿè¡Œ
  scrollToBottom();
</script>
