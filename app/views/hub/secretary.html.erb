<% content_for :head do %>
  <%= stylesheet_link_tag "hub", "data-turbo-track": "reload" %>
<% end %>

<div class="secretary-container">
  <!-- „Éò„ÉÉ„ÉÄ„ÉºÔºàÂõ∫ÂÆöÔºâ -->
  <div class="secretary-header">
    <%= link_to "‚Üê", root_path, class: "back-link" %>
    <div class="header-info">
      <h1>ü§µ ÁßòÊõ∏</h1>
      <p>mode A</p>
    </div>
  </div>

  <!-- ‰ºöË©±„Ç®„É™„Ç¢Ôºà„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩÔºâ -->
  <div class="secretary-chat" id="chat-messages">
    <% if @messages.blank? %>
      <div class="empty-state">
        <p>„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
        <p class="sub">‰Ωï„Åß„ÇÇË©±„Åó„Åã„Åë„Å¶„Åè„Å†„Åï„ÅÑ</p>
      </div>
    <% else %>
      <div class="chat-container">
        <% @messages.each do |message| %>
          <div class="chat-message <%= message.role == 'user' ? 'chat-message-user' : '' %>">
            <div class="chat-avatar <%= message.role == 'assistant' ? 'chat-avatar-assistant' : '' %>">
              <%= message.role == 'user' ? 'ta9' : 'ÁßòÊõ∏' %>
            </div>
            <div class="chat-message-content">
              <div class="chat-bubble <%= message.role == 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant' %>">
                <%= simple_format(message.content) %>
                <% if message.image_url.present? %>
                  <img src="<%= message.image_url %>" class="chat-image" alt="Ê∑ª‰ªòÁîªÂÉè">
                <% end %>
              </div>
              <div class="chat-time">
                <%= message.created_at.strftime('%H:%M') %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ÔºàÂõ∫ÂÆöÔºâ -->
  <div class="secretary-input">
    <%= form_with url: hub_send_message_path,
                  method: :post,
                  multipart: true,
                  data: {
                    controller: "line-chat",
                    action: "submit->line-chat#send"
                  } do |f| %>

      <div data-line-chat-target="previewContainer" style="display: none;" class="image-preview-container">
        <img data-line-chat-target="preview" class="image-preview" />
        <button type="button" class="image-preview-remove" data-action="click->line-chat#removeImage">ÂâäÈô§</button>
      </div>

      <div class="input-toolbar">
        <label class="input-attach-btn">
          Ôºã
          <%= f.file_field :image,
                           accept: "image/*",
                           capture: "environment",
                           style: "display: none;",
                           data: {
                             action: "change->line-chat#previewImage",
                             "line-chat-target": "fileInput"
                           } %>
        </label>

        <div class="input-field-wrapper">
          <%= f.text_area :message,
                          rows: 1,
                          placeholder: "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...",
                          data: {
                            "line-chat-target": "input",
                            action: "keydown->line-chat#handleKeydown input->line-chat#autoResize"
                          } %>
          <button type="submit" class="input-send-btn" data-line-chat-target="submit">‚ñ∂</button>
        </div>
      </div>

      <div class="model-select">
        <%= f.select :model,
                     [["Sonnet 4.5", "claude-sonnet-4.5"], ["GPT-4o", "gpt-4o"]],
                     {} %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // ÊúÄÊñ∞„É°„ÉÉ„Çª„Éº„Ç∏„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
  document.addEventListener('DOMContentLoaded', function() {
    const chat = document.getElementById('chat-messages');
    if (chat) chat.scrollTop = chat.scrollHeight;
  });
  document.addEventListener('turbo:load', function() {
    const chat = document.getElementById('chat-messages');
    if (chat) chat.scrollTop = chat.scrollHeight;
  });
</script>
