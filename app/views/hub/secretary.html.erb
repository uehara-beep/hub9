<% content_for :head do %>
  <%= stylesheet_link_tag "hub", "data-turbo-track": "reload" %>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
<% end %>

<div class="sec">
  <!-- Header -->
  <header class="sec-hdr">
    <%= link_to "←", root_path, class: "sec-back" %>
    <div class="sec-mia">
      <div class="mia-av">Mia</div>
      <div class="sec-mia-ring"></div>
    </div>
    <div class="sec-info">
      <div class="sec-nm">Mia <span class="sec-badge">AI</span></div>
      <div class="sec-stat">
        <span class="sec-dot"></span>
        Online
      </div>
    </div>
    <span class="sec-brand">HUB9</span>
  </header>

  <!-- Chat Area -->
  <div class="ch" id="chat-messages">
    <% if @messages.blank? %>
      <!-- Intro -->
      <div class="intro">
        <div class="mia-av">Mia</div>
        <div class="intro-nm">Mia</div>
        <div class="intro-role">AI SECRETARY</div>
        <div class="intro-bio">
          ta9専属の<strong>毒舌</strong>秘書。<br>
          効率重視、無駄話は嫌い。<br>
          でも仕事はできる。
        </div>
        <div class="ptags">
          <span class="ptag">毒舌</span>
          <span class="ptag">効率厨</span>
          <span class="ptag">仕事人</span>
        </div>
      </div>
    <% else %>
      <% @messages.each do |message| %>
        <div class="r <%= message.role == 'user' ? 'me' : '' %>">
          <div class="r-av <%= message.role == 'assistant' ? 'r-av-mia' : 'r-av-user' %>">
            <%= message.role == 'user' ? 'ta9' : 'Mia' %>
          </div>
          <div class="r-c">
            <div class="bb">
              <%= simple_format(message.content) %>
              <% if message.image_url.present? %>
                <img src="<%= message.image_url %>" class="chat-image" alt="Image">
              <% end %>
            </div>
            <div class="bt"><%= message.created_at.strftime('%H:%M') %></div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Input Area -->
  <div class="sinp">
    <%= form_with url: hub_send_message_stream_path,
                  method: :post,
                  multipart: true,
                  data: {
                    controller: "line-chat",
                    action: "submit->line-chat#send",
                    "line-chat-stream-url-value": hub_send_message_stream_path
                  } do |f| %>

      <div data-line-chat-target="previewContainer" style="display: none;" class="image-preview-container">
        <img data-line-chat-target="preview" class="image-preview" />
        <button type="button" class="image-preview-remove" data-action="click->line-chat#removeImage">X</button>
      </div>

      <!-- Quick Actions -->
      <div class="qa">
        <button type="button" class="qb" data-action="click->line-chat#insertQuick" data-text="今日のタスク教えて">
          Tasks
        </button>
        <button type="button" class="qb" data-action="click->line-chat#insertQuick" data-text="Chargeの残高">
          Balance
        </button>
        <button type="button" class="qb" data-action="click->line-chat#insertQuick" data-text="予定を確認">
          Schedule
        </button>
      </div>

      <div class="sir">
        <label class="input-attach-btn">
          +
          <%= f.file_field :image,
                           accept: "image/*",
                           capture: "environment",
                           style: "display: none;",
                           data: {
                             action: "change->line-chat#previewImage",
                             "line-chat-target": "fileInput"
                           } %>
        </label>

        <div class="sib">
          <%= f.text_area :message,
                          rows: 1,
                          placeholder: "Ask Mia anything...",
                          class: "sta",
                          data: {
                            "line-chat-target": "input",
                            action: "keydown->line-chat#handleKeydown input->line-chat#autoResize"
                          } %>
          <button type="submit" class="sgo" data-line-chat-target="submit">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 8h12M10 4l4 4-4 4"/></svg>
          </button>
        </div>
      </div>

      <div class="smeta">
        <%= f.select :model,
                     [["Sonnet 4.5", "claude-sonnet-4.5"], ["GPT-4o", "gpt-4o"]],
                     {},
                     class: "msel" %>
        <%= button_to "Clear", hub_clear_messages_path,
            method: :delete,
            class: "clr",
            data: { turbo_confirm: "Clear all messages?" } %>
      </div>
    <% end %>
  </div>
</div>

<script>
  function scrollToBottom() {
    const chat = document.getElementById('chat-messages');
    if (chat) chat.scrollTop = chat.scrollHeight;
  }
  document.addEventListener('DOMContentLoaded', scrollToBottom);
  document.addEventListener('turbo:load', scrollToBottom);
  document.addEventListener('turbo:render', scrollToBottom);
  window.addEventListener('load', () => setTimeout(scrollToBottom, 100));
  scrollToBottom();
</script>
