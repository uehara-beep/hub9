<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Vault</title>
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag "vault", "data-turbo-track": "reload" %>
</head>
<body class="vault-body">
  <div class="vault-wrap">
    <div class="vault-card">
      <div class="vault-title">ðŸ”’ Vault</div>
      <div class="vault-sub">PINã‚’å…¥åŠ›</div>

      <%= form_with url: "/vault/unlock", method: :post, local: true, class: "vault-pin-form" do %>
        <input id="pin-input" name="pin" class="vault-pin-input" inputmode="numeric" pattern="[0-9]*"
               maxlength="4" autocomplete="one-time-code" placeholder="â€¢â€¢â€¢â€¢" />

        <div class="vault-pin-grid" aria-label="PIN keypad">
          <% [1,2,3,4,5,6,7,8,9].each do |n| %>
            <button type="button" class="vault-pin-key" data-num="<%= n %>"><%= n %></button>
          <% end %>

          <button type="button" class="vault-pin-key vault-pin-key--ghost" id="pin-clear">C</button>
          <button type="button" class="vault-pin-key" data-num="0">0</button>
          <button type="submit" class="vault-pin-key vault-pin-key--ok">OK</button>
        </div>

        <% if flash[:alert].present? %>
          <div class="vault-alert"><%= flash[:alert] %></div>
        <% end %>
      <% end %>
    </div>
  </div>

  <script>
  (function(){
    const input = document.getElementById("pin-input");
    const keys  = document.querySelectorAll(".vault-pin-key[data-num]");
    const clear = document.getElementById("pin-clear");

    const focusInput = () => { try { input.focus({preventScroll:true}); } catch(e) { input.focus(); } };

    keys.forEach(btn => {
      btn.addEventListener("click", () => {
        focusInput();
        const n = btn.dataset.num;
        if (!n) return;
        if (input.value.length >= 4) return;
        input.value = (input.value || "") + n;
      }, {passive:true});
    });

    clear.addEventListener("click", () => {
      input.value = "";
      focusInput();
    }, {passive:true});

    setTimeout(focusInput, 50);
  })();
  </script>
</body>
</html>
