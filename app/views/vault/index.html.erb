<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Vault</title>
  <%= csrf_meta_tags %>
  <style>
    :root {
      --bg: #f6f3ef;
      --hermes: #ff7a00;
      --text: #1a1a1a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", sans-serif;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 24px;
      color: var(--text);
    }
    .pin-dots {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
    }
    .pin-dots span {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ddd;
      transition: background 0.15s;
    }
    .pin-dots span.filled {
      background: var(--hermes);
    }
    .pin-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      max-width: 280px;
    }
    .vault-pin-key {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: none;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
      font-size: 28px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      touch-action: manipulation;
      pointer-events: auto;
      z-index: 10;
      -webkit-tap-highlight-color: transparent;
    }
    .vault-pin-key:active {
      background: #f0ebe5;
      transform: scale(0.95);
    }
    .pin-pad-row {
      display: contents;
    }
    .pin-error {
      color: #c0392b;
      margin-top: 16px;
      font-size: 14px;
    }
    #pin-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>üîí Vault</h1>

  <div class="pin-dots" id="pin-dots">
    <span></span><span></span><span></span><span></span>
  </div>

  <input type="password" id="pin-input" maxlength="4" autocomplete="off">

  <div class="pin-pad">
    <% (1..9).each do |n| %>
      <button type="button" class="vault-pin-key" data-num="<%= n %>"><%= n %></button>
    <% end %>
    <div></div>
    <button type="button" class="vault-pin-key" data-num="0">0</button>
    <button type="button" class="vault-pin-key" data-num="del">‚Üê</button>
  </div>

  <div class="pin-error" id="pin-error" style="display:none;">PIN„ÅåÈÅï„ÅÑ„Åæ„Åô</div>

  <script>
    const input = document.getElementById('pin-input');
    const dots = document.querySelectorAll('#pin-dots span');
    const errorEl = document.getElementById('pin-error');

    function updateDots() {
      const len = input.value.length;
      dots.forEach((dot, i) => {
        dot.classList.toggle('filled', i < len);
      });
    }

    document.querySelectorAll('.vault-pin-key').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const num = btn.dataset.num;

        if (num === 'del') {
          input.value = input.value.slice(0, -1);
        } else if (input.value.length < 4) {
          input.value += num;
        }

        updateDots();
        errorEl.style.display = 'none';

        if (input.value.length === 4) {
          submitPin();
        }
      });
    });

    async function submitPin() {
      const pin = input.value;
      try {
        const res = await fetch('/api/vault/unlock', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ pin })
        });
        const data = await res.json();
        if (data.ok) {
          window.location.href = '/vault/home';
        } else {
          errorEl.style.display = 'block';
          input.value = '';
          updateDots();
        }
      } catch (e) {
        errorEl.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
        errorEl.style.display = 'block';
        input.value = '';
        updateDots();
      }
    }
  </script>
</body>
</html>
